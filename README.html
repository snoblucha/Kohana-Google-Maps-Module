<h1>Kohana Google Maps Module V2.0</h1>

<p>With this module you can easily add a Google Map to your Kohana installation!</p>

<p>The Google Map module has NO dependency to other modules! Just jQuery. For multiple maps
compatibility.</p>

<h2>Features</h2>

<ul>
<li>Display a Google-Map by just echo'ing an instance of the "Gmap" class</li>
<li>Setting several map-types (road, satellite, hybrid and terrain)</li>
<li>Setting sensor-parameter (for mobile devices)</li>
<li>Adding markers to the map (including custom icon and Google Maps popups)</li>
<li>Adding polylines to the map</li>
<li>Adding polygons to the map</li>
<li>Setting the positions and types for the map-controls</li>
<li>Auto zooming on added objects</li>
<li>Auto centering the map</li>
</ul>

<h2>Usage</h2>

<p>The usage of this module is as easy as it could be! Simply activate the module in your bootstrap.php</p>

<pre><code>/**
 * Enable modules. Modules are referenced by a relative or absolute path.
 */
Kohana::modules(array(
    // ...
    'gmap'       =&gt; MODPATH.'gmap',       // A simple google-maps module
));
</code></pre>

<p>Then you'll just echo an instance of the gmap class in your action... For example:</p>

<pre><code>public function action_index()
{
    $this-&gt;template-&gt;map = Gmap::factory();
} // function
</code></pre>

<p>This is a more advanced example with usage of various options...</p>

<pre><code>public function action_index()
{
        $gmap = Gmap::factory('map1');

        //set map type
        $gmap-&gt;setMaptype(Gmap_Maptype::HYBRID());

        $gmap-&gt;getControls()-&gt;getMaptype()-&gt;setType(Gmap_Controls_Maptype::TYPE_HORIZONTAL);

        //positions of controls - maptype and navigation
        $gmap-&gt;getControls()-&gt;getMaptype()-&gt;setPosition(Gmap_Controls_Maptype::POSITION_BOTTOM_LEFT);

        //hide the controls
        $gmap-&gt;getControls()-&gt;getNavigation()-&gt;setDisplay(false);

        $gmap-&gt;setZoom(11);
        $gmap-&gt;addMarker(Gmap_Marker::factory('test', 50.6, 14.0)-&gt;setContent('Test content'));
        $gmap-&gt;addMarker(Gmap_Marker::factory('test_no_content', 50.6, 14.5));
        $gmap-&gt;addMarker(Gmap_Marker::factory('test_no_content_icon', 50.2, 14.4)-&gt;setIcon('/img/heating-and-aircon.png'));

        //geocoding
        $find_address = Gmap_Geocode::geocode('adresa','Anezky Ceske 629/3, Usti nad Labem');

        //on geocode success will be called javascript function saveGps(request)
        $find_address-&gt;setOnSuccess('saveGps');
        $gmap-&gt;addGeocode($find_address);

        //polyline

        $polygon = new Gmap_Polygon('square');
        $polygon-&gt;addPoint(49, 14)-&gt;addPoint(48, 14)-&gt;addPoint(48, 13)-&gt;addPoint(49, 13);
        $polygon-&gt;setFillColor('#ff00ff')-&gt;setFillOpacity(0.25)-&gt;setStrokeColor("#00ff00")-&gt;setStrokeOpacity(0.75)-&gt;setStrokeWeight(2.5);
        $gmap-&gt;addPolygon($polygon);


        //second map
        $gmap2 = Gmap::factory('map2')-&gt;addMarker(Gmap_Marker::factory('Test on second map', 50.7, 14.0)-&gt;setContent('Marker on second map'));

        $this-&gt;template-&gt;content = $gmap-&gt;render() . $gmap2-&gt;render();
    } // function
</code></pre>

<h2>Enabling map</h2>

<p>Map is enabled on first map render, or if you want to have better control,
where the initial script should be you can call <code>Gmap::enable();</code> at particular location.</p>

<p>If you want the best control, you can call <code>Gmap::setEnabled()</code>  which can set the flag to desired
value. Or you can set <code>disableAutoEnable</code> in config.</p>

<p>But then you have to take care about javascript initialization. See <code>view/gmap_enable.php</code>.
Generally it takes two steps. First is to include google map api.</p>

<pre><code>&lt;script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=&lt;?php echo Gmap::getSensor() ? 'true' : 'false'; ?&gt;"&gt;&lt;/script&gt;
</code></pre>

<p>And then you must include also <code>js/gmap.js</code> javascript as well.</p>

<h2>Javascript access</h2>

<p>In javascript the gmaps variable is created. It is javascript object see <code>views/gmap_enable.php</code>.
Each map instance is accessible in javascript by <code>gmaps['map_id']</code>. If <code>map_id</code>
is not explicitly set in constructor or later in the code, autogenerated value is used.</p>

<h3>Javascript constructor</h3>

<pre><code>function Gmap(options){

    this.options = options;
    this.polyline_coords = {};
    this.polylines = {};
    this.polygons = {};
    this.polygon_coords = {};
    this.markers = {};
    this.info_windows = {};
    this.geocode_request = {};
    this.geocode_result = {};
};
</code></pre>

<h2>Variables in javascript</h2>

<p>After the initialization of the map you may access all added objects for further processing.
Usefull is access to geocode results in case you want to save geocoded values.</p>

<pre><code>Gmap::factory('map_id')
        -&gt;add_marker_address('my_marker','address, city')
        -&gt;render();
</code></pre>

<ul>
<li>In javascript you will then have variable <code>gmaps['map_id']</code>.</li>
<li><code>gmaps['map_id'].map</code> is instance of <code>google.maps.Map</code>.</li>
<li><code>gmaps['map_id']['markers']['my_marker']</code> is instance of <code>google.maps.Marker</code>.</li>
<li><code>In gmaps['map_id'].geocode_result['my_marker']</code> is result from the call to <code>geocoder.geocode</code></li>
</ul>

<p>and so on.</p>

<h3>Example</h3>

<p>You have initialized instance of the map <code>Gmap::factory('map')</code>. And added some addresses to
geocode. In app you have  button <code>&lt;a href="#" id="save_gps"&gt;save result&lt;/a&gt;</code>. And javascript given below.
Also you have outputted list of markers withe <code>rel</code> attribute <code>marker_MARKERID</code> on the map.
Eg. <code>$gmap-&gt;addMarker('marker1')</code> <code>&lt;a href="#" rel="marker_marker1"&gt;Marker 1&lt;/a&gt;</code> and you then
can control map movement and geocode saving from the links.</p>

<pre><code>&lt;script type="text/javascript"&gt;
    $(function(){
        $('#save_gps').click(function(){

            for(i in gmaps['map'].geocode_result){

                var loc = gmaps['map'].geocode_result[i][0].geometry.location;
                var lat = loc.lat();
                var lng = loc.lng();
                var gps = ((lat &gt; 0 ) ? 'N' : 'S')+Math.abs(lat)+' '+((lng &gt; 0 ) ? 'E' : 'W')+Math.abs(lng);
                $.post('updategps',{id:i,gps:gps});
            }
            return false;
        });

        $('.marker').click(function(){
            google.maps.event.trigger(gmaps['map'].map,'resize');
            var marker_name = $(this).attr('rel');
            var id = marker_name.split('_');
            var marker = gmaps['map'].markers[id[1]];
            if(marker) gmaps['map'].map.setCenter(marker.getPosition());
            return false;
        });
    });
&lt;/script&gt;
</code></pre>